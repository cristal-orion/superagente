<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PV Sales Calculator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div class="app">
      <!-- Ambient Background -->
      <div class="ambient-bg">
        <div class="gradient-orb orb-1"></div>
        <div class="gradient-orb orb-2"></div>
        <div class="gradient-orb orb-3"></div>
      </div>

      <!-- Header -->
      <header class="header">
        <div class="logo">
          <img src="./logotech.png" alt="Tech Solutions" class="logo-img" />
        </div>
        <div class="header-right">
          <div class="header-tagline">Calcola il tuo risparmio energetico</div>
          <button class="theme-toggle" id="themeToggle" aria-label="Cambia tema">
            <span class="theme-icon theme-icon-dark">üåô</span>
            <span class="theme-icon theme-icon-light">‚òÄÔ∏è</span>
          </button>
        </div>
      </header>

      <main class="main-grid">
        <!-- Left Panel: Inputs -->
        <aside class="input-panel">
          <form id="calcForm" class="calc-form" autocomplete="off">

            <!-- Section: Consumi -->
            <details class="input-section" open>
              <summary class="section-header">
                <span class="section-icon">‚ö°</span>
                <span class="section-title">Consumi Attuali</span>
                <span class="section-chevron">‚Ä∫</span>
              </summary>
              <div class="section-content">
                <div class="field">
                  <label for="fornitore">Fornitore energia</label>
                  <select id="fornitore"></select>
                </div>
                <div class="field-row">
                  <div class="field">
                    <label for="consumo_annuo_kwh">Consumo annuo</label>
                    <div class="input-with-unit">
                      <input id="consumo_annuo_kwh" type="number" step="1" min="1" value="3500" />
                      <span class="unit">kWh</span>
                    </div>
                  </div>
                  <div class="field">
                    <label for="prezzo_energia_eur_kwh">Prezzo energia</label>
                    <div class="input-with-unit">
                      <input id="prezzo_energia_eur_kwh" type="number" step="0.01" min="0.01" value="0.30" />
                      <span class="unit">‚Ç¨/kWh</span>
                    </div>
                  </div>
                </div>
                <div class="field">
                  <label for="quota_fissa_annua_eur">Quota fissa annua</label>
                  <div class="input-with-unit">
                    <input id="quota_fissa_annua_eur" type="number" step="1" min="0" value="0" />
                    <span class="unit">‚Ç¨</span>
                  </div>
                </div>
              </div>
            </details>

            <!-- Section: Impianto -->
            <details class="input-section" open>
              <summary class="section-header">
                <span class="section-icon">‚òÄÔ∏è</span>
                <span class="section-title">Impianto Fotovoltaico</span>
                <span class="section-chevron">‚Ä∫</span>
              </summary>
              <div class="section-content">
                <div class="field">
                  <label for="modello_impianto">Modello impianto</label>
                  <select id="modello_impianto"></select>
                </div>
                <div class="field">
                  <label for="piano_rate_mesi">Piano rate</label>
                  <select id="piano_rate_mesi" disabled></select>
                </div>
                <div class="field-row">
                  <div class="field">
                    <label for="costo_impianto_eur">Costo impianto</label>
                    <div class="input-with-unit">
                      <input id="costo_impianto_eur" type="number" step="100" min="1" value="12000" />
                      <span class="unit">‚Ç¨</span>
                    </div>
                  </div>
                  <div class="field">
                    <label for="anticipo_eur">Anticipo</label>
                    <div class="input-with-unit">
                      <input id="anticipo_eur" type="number" step="100" min="0" value="0" />
                      <span class="unit">‚Ç¨</span>
                    </div>
                  </div>
                </div>
                <div class="field-row">
                  <div class="field">
                    <label for="anni_finanziamento">Finanziamento</label>
                    <div class="input-with-unit">
                      <input id="anni_finanziamento" type="number" step="1" min="1" max="30" value="10" />
                      <span class="unit">anni</span>
                    </div>
                  </div>
                  <div class="field">
                    <label for="produzione_annua_kwh">Produzione</label>
                    <div class="input-with-unit">
                      <input id="produzione_annua_kwh" type="number" step="1" min="1" value="4500" />
                      <span class="unit">kWh/anno</span>
                    </div>
                  </div>
                </div>
              </div>
            </details>

            <!-- Section: Parametri Avanzati -->
            <details class="input-section">
              <summary class="section-header">
                <span class="section-icon">‚öôÔ∏è</span>
                <span class="section-title">Parametri Avanzati</span>
                <span class="section-chevron">‚Ä∫</span>
              </summary>
              <div class="section-content">
                <div class="field-row">
                  <div class="field">
                    <label for="autoconsumo_percent">Autoconsumo</label>
                    <div class="input-with-unit">
                      <input id="autoconsumo_percent" type="number" step="1" min="0" max="100" value="40" />
                      <span class="unit">%</span>
                    </div>
                  </div>
                  <div class="field">
                    <label for="prezzo_gse_eur_kwh">Prezzo GSE</label>
                    <div class="input-with-unit">
                      <input id="prezzo_gse_eur_kwh" type="number" step="0.01" min="0" value="0.10" />
                      <span class="unit">‚Ç¨/kWh</span>
                    </div>
                  </div>
                </div>
                <div class="field-row">
                  <div class="field">
                    <label for="aliquota_detrazione_percent">Detrazione fiscale</label>
                    <div class="input-with-unit">
                      <input id="aliquota_detrazione_percent" type="number" step="1" min="0" max="100" value="50" />
                      <span class="unit">%</span>
                    </div>
                  </div>
                  <div class="field">
                    <label for="anni_detrazione">Anni detrazione</label>
                    <div class="input-with-unit">
                      <input id="anni_detrazione" type="number" step="1" min="1" max="20" value="10" />
                      <span class="unit">anni</span>
                    </div>
                  </div>
                </div>
                <div class="field inline-field">
                  <input id="usa_rata_semplice" type="checkbox" checked />
                  <label for="usa_rata_semplice">Rata semplice (costo/anni)</label>
                </div>
                <div class="field-row">
                  <div class="field">
                    <label for="taeg_annuo_percent">TAEG annuo</label>
                    <div class="input-with-unit">
                      <input id="taeg_annuo_percent" type="number" step="0.1" min="0" value="0" />
                      <span class="unit">%</span>
                    </div>
                  </div>
                  <div class="field">
                    <label for="fattore_prudenza">Fattore prudenza</label>
                    <input id="fattore_prudenza" type="number" step="0.01" min="0.5" max="1.2" value="1.0" />
                  </div>
                </div>
              </div>
            </details>

            <div class="api-status" id="apiStatus"></div>
          </form>
        </aside>

        <!-- Right Panel: Results -->
        <section class="results-panel">

          <!-- Hero: Main Savings Display -->
          <div class="hero-result">
            <div class="hero-label">Il tuo risparmio annuo</div>
            <div class="hero-value" id="delta">
              <span class="hero-currency">‚Ç¨</span>
              <span class="hero-number">‚Äî</span>
            </div>
            <div class="hero-message" id="messaggio">Inserisci i dati per calcolare</div>
            <div class="hero-comparison">
              <div class="comparison-item">
                <span class="comparison-label">Spesa attuale</span>
                <span class="comparison-value" id="spesa_attuale">‚Äî</span>
              </div>
              <div class="comparison-arrow">‚Üí</div>
              <div class="comparison-item">
                <span class="comparison-label">Costo netto</span>
                <span class="comparison-value" id="costo_netto">‚Äî</span>
              </div>
            </div>
            <button class="btn-preventivo" id="openPdfModal">
              <span class="btn-preventivo-icon">üìÑ</span>
              <span class="btn-preventivo-text">Genera Preventivo PDF</span>
            </button>
          </div>

          <!-- Stats Cards -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon">üí∞</div>
              <div class="stat-content">
                <div class="stat-value" id="rata">‚Äî</div>
                <div class="stat-label">Rata annua</div>
              </div>
            </div>
            <div class="stat-card stat-positive">
              <div class="stat-icon">üèõÔ∏è</div>
              <div class="stat-content">
                <div class="stat-value" id="detrazione">‚Äî</div>
                <div class="stat-label">Detrazione fiscale</div>
              </div>
            </div>
            <div class="stat-card stat-positive">
              <div class="stat-icon">‚ö°</div>
              <div class="stat-content">
                <div class="stat-value" id="risparmio">‚Äî</div>
                <div class="stat-label">Risparmio bolletta</div>
              </div>
            </div>
            <div class="stat-card stat-positive">
              <div class="stat-icon">üîå</div>
              <div class="stat-content">
                <div class="stat-value" id="ricavo_gse">‚Äî</div>
                <div class="stat-label">Ricavo GSE</div>
              </div>
            </div>
          </div>

          <!-- Charts Section -->
          <div class="charts-section">
            <div class="chart-container chart-breakdown">
              <div class="chart-header">
                <h3>Composizione Costi/Benefici</h3>
              </div>
              <div class="chart-body">
                <canvas id="pieBreakdown"></canvas>
                <div class="chart-legend" id="pieLegend"></div>
              </div>
            </div>

            <div class="chart-container chart-cashflow">
              <div class="chart-header">
                <h3>Proiezione 25 Anni</h3>
                <div class="chart-badge" id="anno11Badge">
                  <span class="badge-label">Dopo finanziamento:</span>
                  <span class="badge-value" id="anno11">‚Äî</span>
                </div>
              </div>
              <div class="chart-body">
                <canvas id="cashflowChart"></canvas>
              </div>
              <div class="chart-footer">
                <span class="legend-dot positive"></span> Risparmio
                <span class="legend-dot negative"></span> Costo
              </div>
            </div>
          </div>

          <!-- Expandable Table -->
          <details class="cashflow-table-section">
            <summary class="table-toggle">
              <span>üìä Dettaglio annuale completo</span>
              <span class="toggle-icon">+</span>
            </summary>
            <div class="table-wrapper">
              <table class="cashflow-table">
                <thead>
                  <tr>
                    <th>Anno</th>
                    <th>Costo Netto Annuo</th>
                  </tr>
                </thead>
                <tbody id="cashflowBody"></tbody>
              </table>
            </div>
          </details>

        </section>
      </main>
    </div>

    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="./app.js"></script>

    <!-- Modal Preventivo -->
    <div class="modal-overlay" id="pdfModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Genera Preventivo</h2>
          <button class="modal-close" id="modalClose">&times;</button>
        </div>
        <div class="modal-body">
          <div class="field">
            <label for="clienteName">Nome Cliente</label>
            <input type="text" id="clienteName" placeholder="Es. Sig. Rossi" autocomplete="off" />
          </div>
          <div class="field">
            <label for="clienteIndirizzo">Indirizzo (opzionale)</label>
            <input type="text" id="clienteIndirizzo" placeholder="Es. Via Roma 123, Milano" autocomplete="off" />
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="modalCancel">Annulla</button>
          <button class="btn btn-primary" id="generatePdf">
            <span class="btn-icon">üìÑ</span>
            Genera PDF
          </button>
        </div>
      </div>
    </div>
  </body>
</html>
